<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gatot Kaca Search Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Poppins', 'ui-sans-serif', 'system-ui', 'sans-serif'],
            },
            colors: {
              primary: '#0EA5E9', // sky-500
              secondary: '#22C55E', // green-500
              accent: '#F59E0B', // amber-500
              dark: '#1E293B', // slate-800
              light: '#F8FAFC', // slate-50
            },
            animation: {
              'spin-slow': 'spin 2s linear infinite',
            },
          },
        },
        plugins: [
          function({ addComponents }) {
            addComponents({
              '.btn': {
                padding: '0.5rem 1rem',
                borderRadius: '0.5rem',
                fontWeight: '500',
                display: 'inline-flex',
                alignItems: 'center',
                justifyContent: 'center',
                transition: 'all 200ms ease-out',
                '&:focus-visible': {
                  outline: 'none',
                  boxShadow: '0 0 0 4px rgba(14, 165, 233, 0.5)',
                },
              },
              '.btn-primary': {
                backgroundColor: '#0EA5E9',
                color: 'white',
                '&:hover': {
                  backgroundColor: '#0284C7',
                },
                '&:active': {
                  transform: 'scale(0.98)',
                },
              },
              '.btn-secondary': {
                backgroundColor: '#F59E0B',
                color: 'white',
                '&:hover': {
                  backgroundColor: '#D97706',
                },
                '&:active': {
                  transform: 'scale(0.98)',
                },
              },
              '.no-scrollbar': {
                '-ms-overflow-style': 'none',
                'scrollbar-width': 'none',
                '&::-webkit-scrollbar': {
                  display: 'none',
                },
              },
            })
          }
        ]
      }
    </script>
    <style>
        /* Batik pattern overlay for hero section */
        .batik-pattern {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cg fill='%23ffffff' fill-opacity='0.08'%3E%3Cpath d='M0 0h40v40H0V0zm40 40h40v40H40V40zm0-40h2l-2 2V0zm0 4l4-4h2l-6 6V4zm0 4l8-8h2L40 10V8zm0 4L52 0h2L40 14v-2zm0 4L56 0h2L40 18v-2zm0 4L60 0h2L40 22v-2zm0 4L64 0h2L40 26v-2zm0 4L68 0h2L40 30v-2zm0 4L72 0h2L40 34v-2zm0 4L76 0h2L40 38v-2zm0 4L80 0v2L42 40h-2zm4 0L80 4v2L46 40h-2zm4 0L80 8v2L50 40h-2zm4 0l28-28v2L54 40h-2zm4 0l24-24v2L58 40h-2zm4 0l20-20v2L62 40h-2zm4 0l16-16v2L66 40h-2zm4 0l12-12v2L70 40h-2zm4 0l8-8v2l-6 6h-2zm4 0l4-4v2l-2 2h-2z'/%3E%3C/g%3E%3C/svg%3E");
        }
        
        .search-container {
            background: linear-gradient(135deg, #0EA5E9 0%, #7C3AED 100%);
        }
        
        .result-item {
            transition: all 0.2s ease-out;
        }
        
        .result-item:hover {
            transform: translateY(-2px);
        }
        
        .loading {
            display: none;
        }
        
        .loading.show {
            display: block;
        }
        
        mark {
            background-color: rgba(251, 191, 36, 0.4);
            padding: 0 0.1rem;
            border-radius: 0.25rem;
        }
        
        .dark mark {
            background-color: rgba(251, 191, 36, 0.25);
            color: rgba(255, 255, 255, 0.9);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
        }
        
        /* Custom select arrow */
        .select-arrow {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%231E293B'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-size: 1rem;
            background-position: center right 1rem;
            background-repeat: no-repeat;
        }
        
        .dark .select-arrow {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23F8FAFC'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 min-h-screen font-sans text-slate-800 dark:text-slate-100">
  <!-- Dark Mode Toggle -->
  <div class="absolute top-4 right-4 z-50">
    <button id="darkModeToggle" aria-label="Toggle dark mode" class="p-2 rounded-full bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">
      <i class="fas fa-sun dark:hidden"></i>
      <i class="fas fa-moon hidden dark:block"></i>
    </button>
  </div>

  <!-- Header dengan gradient dan batik pattern -->
  <header class="search-container batik-pattern text-white py-16 md:py-20 relative">
    <div class="max-w-5xl mx-auto px-4 sm:px-6">
      <div class="text-center mb-10">
        <h1 class="inline-flex items-center justify-center gap-3 text-4xl md:text-5xl font-bold mb-3">
          <i class="fas fa-shield-alt"></i>Gatot Kaca Search
        </h1>
        <p class="text-white/80 text-lg md:text-xl">Temukan informasi tentang sejarah dan wisata Indonesia</p>
      </div>
      
      <!-- Search Box Container (Elevated Card) -->
      <div class="relative -mb-20">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-3 md:p-4 mx-auto max-w-3xl">
          <div class="flex flex-col md:flex-row gap-3">
            <div class="flex flex-1 flex-col sm:flex-row gap-3">
              <!-- Search Input -->
              <div class="relative flex-1">
                <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-slate-400 dark:text-slate-500">
                  <i class="fas fa-search"></i>
                </span>
                <input 
                  id="q" 
                  type="text" 
                  placeholder="Cari informasi tentang Indonesia..." 
                  aria-label="Kata kunci pencarian"
                  class="w-full pl-11 pr-4 py-3 md:py-3.5 rounded-xl text-base md:text-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-100 placeholder:text-slate-400 focus:outline-none focus:ring-4 focus:ring-sky-300 dark:focus:ring-sky-700/50"
                  onkeypress="handleEnter(event)">
              </div>
              
              <!-- Category Filter -->
              <div class="min-w-[9rem] md:min-w-[11rem]">
                <select 
                  id="category" 
                  aria-label="Filter kategori" 
                  title="Filter berdasarkan kategori" 
                  class="w-full px-4 py-3 md:py-3.5 rounded-xl text-base md:text-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-100 focus:outline-none focus:ring-4 focus:ring-sky-300 dark:focus:ring-sky-700/50 appearance-none select-arrow pr-10">
                  <option value="Semua">Semua Kategori</option>
                  <!-- Categories loaded dynamically -->
                </select>
              </div>
            </div>
            
            <!-- Search Button -->
            <button 
              onclick="doSearch()" 
              aria-label="Lakukan pencarian"
              class="btn btn-secondary py-3 md:py-3.5 px-6 text-base md:text-lg rounded-xl font-semibold shadow-md hover:shadow-lg transition-all duration-200 hover:scale-[1.02] active:scale-[0.98]">
              <i class="fas fa-search mr-2"></i>Cari
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="pt-24 pb-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6">
      
      <!-- Quick Search Chips -->
      <div class="overflow-x-auto no-scrollbar pb-4 -mt-2">
        <div class="flex flex-nowrap gap-2 justify-center">
          <button 
            onclick="quickSearch('sejarah indonesia')" 
            aria-label="Cari sejarah Indonesia"
            class="glass-card px-4 py-2 rounded-full text-white hover:bg-white/20 whitespace-nowrap">
            <i class="fas fa-history mr-2"></i>Sejarah Indonesia
          </button>
          <button 
            onclick="quickSearch('wisata bali')" 
            aria-label="Cari wisata Bali"
            class="glass-card px-4 py-2 rounded-full text-white hover:bg-white/20 whitespace-nowrap">
            <i class="fas fa-map-marker-alt mr-2"></i>Wisata Bali
          </button>
          <button 
            onclick="quickSearch('budaya')" 
            aria-label="Cari budaya"
            class="glass-card px-4 py-2 rounded-full text-white hover:bg-white/20 whitespace-nowrap">
            <i class="fas fa-theater-masks mr-2"></i>Budaya
          </button>
          <button 
            onclick="quickSearch('tradisi')" 
            aria-label="Cari tradisi"
            class="glass-card px-4 py-2 rounded-full text-white hover:bg-white/20 whitespace-nowrap">
            <i class="fas fa-hands-helping mr-2"></i>Tradisi
          </button>
        </div>
      </div>

      <!-- Admin Controls -->
      <div class="flex flex-wrap justify-center gap-2 mb-8">
        <button 
          id="reindexBtn" 
          onclick="reindexDatabase()" 
          aria-label="Reindex database"
          class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full transition-all flex items-center gap-2 focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-indigo-300 dark:focus-visible:ring-indigo-800">
          <i class="fas fa-sync-alt"></i> <span>Reindex Database</span>
        </button>
        <button 
          id="analyzeBtn" 
          onclick="analyzeCorpus()" 
          aria-label="Analisis korpus"
          class="px-4 py-2 bg-sky-600 hover:bg-sky-700 text-white rounded-full transition-all flex items-center gap-2 focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-sky-300 dark:focus-visible:ring-sky-800">
          <i class="fas fa-chart-bar"></i> <span>Analisis Korpus</span>
        </button>
      </div>
      
      <!-- Loading Animation -->
      <div id="loading" class="loading text-center py-8" role="status" aria-live="polite">
        <div class="inline-block animate-spin rounded-full h-10 w-10 border-b-2 border-t-2 border-sky-600 dark:border-sky-500"></div>
        <p class="mt-3 text-slate-600 dark:text-slate-400">
          <i class="fas fa-search mr-1"></i>Mencari informasi...
        </p>
      </div>

      <!-- Search Stats -->
      <div id="searchStats" class="hidden mb-6" aria-live="polite">
        <div class="bg-white/80 dark:bg-slate-800/70 backdrop-blur rounded-xl p-4 shadow-sm border border-slate-200/70 dark:border-slate-700/50">
          <div class="flex items-center gap-2">
            <i class="fas fa-chart-bar text-sky-600 dark:text-sky-400"></i>
            <p class="text-sm text-slate-600 dark:text-slate-300">
              Ditemukan <span id="resultCount" class="font-semibold text-sky-600 dark:text-sky-400">0</span> hasil 
              untuk "<span id="queryText" class="font-semibold text-slate-800 dark:text-white">-</span>" 
              dalam <span id="searchTime" class="font-semibold text-sky-600 dark:text-sky-400 font-mono">0</span>ms
            </p>
          </div>
        </div>
      </div>

      <!-- Results -->
      <div id="results" class="space-y-5" aria-live="polite"></div>
      
      <!-- Pagination Controls -->
      <div id="pagination" class="hidden mt-10 flex justify-center items-center space-x-2">
        <button 
          id="prevPage" 
          onclick="changePage(-1)" 
          aria-label="Halaman sebelumnya"
          class="px-4 py-2 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-sky-300 dark:focus-visible:ring-sky-700/50">
          <i class="fas fa-chevron-left mr-2"></i>Sebelumnya
        </button>
        <div id="pageInfo" class="text-slate-600 dark:text-slate-400 font-medium mx-4">
          Halaman <span id="currentPage" class="font-semibold text-sky-600 dark:text-sky-400">1</span> dari <span id="totalPages" class="font-semibold">1</span>
        </div>
        <button 
          id="nextPage" 
          onclick="changePage(1)" 
          aria-label="Halaman selanjutnya"
          class="px-4 py-2 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-sky-300 dark:focus-visible:ring-sky-700/50">
          Selanjutnya<i class="fas fa-chevron-right ml-2"></i>
        </button>
      </div>

      <!-- Analysis Results Modal -->
      <div 
        id="analysisModal" 
        class="hidden fixed inset-0 bg-black/50 dark:bg-black/70 z-50 flex items-center justify-center backdrop-blur-sm" 
        role="dialog" 
        aria-modal="true" 
        aria-labelledby="analysisTitle">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto border border-slate-200 dark:border-slate-700 shadow-xl">
          <div class="flex justify-between items-center mb-6">
            <h3 id="analysisTitle" class="text-xl font-bold">Analisis Korpus Dokumen</h3>
            <button 
              onclick="closeAnalysisModal()" 
              class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" 
              aria-label="Tutup dialog" 
              title="Tutup">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div id="analysisContent" class="space-y-6">
            <!-- Analysis content will be inserted here -->
          </div>
        </div>
      </div>

      <!-- No Results Message -->
      <div id="noResults" class="hidden text-center py-16">
        <div class="text-7xl mb-6 text-slate-300 dark:text-slate-700">
          <i class="fas fa-search-minus"></i>
        </div>
        <h3 class="text-xl font-semibold text-slate-700 dark:text-slate-300 mb-3">Tidak ada hasil ditemukan</h3>
        <p class="text-slate-500 dark:text-slate-400 mb-6 max-w-lg mx-auto">Coba kata kunci lain atau periksa ejaan Anda</p>
        <div class="flex flex-wrap justify-center gap-3">
          <button 
            onclick="quickSearch('sejarah')" 
            aria-label="Cari sejarah"
            class="px-4 py-2 bg-sky-100 dark:bg-sky-900/30 text-sky-700 dark:text-sky-300 rounded-lg hover:bg-sky-200 dark:hover:bg-sky-900/50 transition-colors">
            <i class="fas fa-history mr-1"></i>Cari "sejarah"
          </button>
          <button 
            onclick="quickSearch('wisata')" 
            aria-label="Cari wisata"
            class="px-4 py-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-lg hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors">
            <i class="fas fa-map-marker-alt mr-1"></i>Cari "wisata"
          </button>
          <button 
            onclick="resetSearch()" 
            aria-label="Reset pencarian"
            class="px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
            <i class="fas fa-redo-alt mr-1"></i>Reset pencarian
          </button>
        </div>
      </div>

      <!-- Welcome Message -->
      <div id="welcome" class="text-center py-12">
        <div class="text-7xl mb-6 text-red-500 dark:text-red-400">
          <i class="fas fa-flag"></i>
        </div>
        <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-4">Selamat Datang di Gatot Kaca Search</h2>
        <p class="text-slate-600 dark:text-slate-300 mb-8 max-w-xl mx-auto">Jelajahi kekayaan informasi tentang sejarah dan wisata Indonesia</p>
        
        <div class="grid sm:grid-cols-2 gap-6 max-w-2xl mx-auto">
          <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 hover:shadow-md transition-all group">
            <div class="text-3xl mb-3 text-sky-600 dark:text-sky-400 group-hover:scale-110 transition-transform">
              <i class="fas fa-book-open"></i>
            </div>
            <h3 class="font-semibold mb-2 text-slate-800 dark:text-slate-200">Sejarah Indonesia</h3>
            <p class="text-sm text-slate-600 dark:text-slate-400">Pelajari perjalanan sejarah bangsa Indonesia dari masa ke masa</p>
            <button 
              onclick="quickSearch('sejarah indonesia')" 
              class="mt-4 px-3 py-1.5 bg-sky-100 dark:bg-sky-900/30 text-sky-700 dark:text-sky-300 text-sm rounded-lg hover:bg-sky-200 dark:hover:bg-sky-900/50 transition-colors"
              aria-label="Cari sejarah Indonesia">
              <i class="fas fa-search mr-1"></i>Jelajahi
            </button>
          </div>
          
          <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 hover:shadow-md transition-all group">
            <div class="text-3xl mb-3 text-green-600 dark:text-green-400 group-hover:scale-110 transition-transform">
              <i class="fas fa-umbrella-beach"></i>
            </div>
            <h3 class="font-semibold mb-2 text-slate-800 dark:text-slate-200">Wisata Indonesia</h3>
            <p class="text-sm text-slate-600 dark:text-slate-400">Temukan destinasi wisata menarik di seluruh nusantara</p>
            <button 
              onclick="quickSearch('wisata indonesia')" 
              class="mt-4 px-3 py-1.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 text-sm rounded-lg hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors"
              aria-label="Cari wisata Indonesia">
              <i class="fas fa-search mr-1"></i>Jelajahi
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-slate-800 dark:bg-slate-900 text-white py-8 border-t border-slate-700/50">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 text-center">
      <p class="text-slate-400">
        <i class="fas fa-copyright mr-1"></i>2025 Gatot Kaca Search Engine. anggapuspa
      </p>
    </div>
  </footer>

<script>
// Global state
let searchStartTime = 0;
let currentPage = 1;
let totalPages = 1;
let currentQuery = '';
let currentCategory = 'Semua';
const RESULTS_PER_PAGE = 20;

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
  loadCategories();
  document.getElementById("q").focus();
  checkDatabaseStatus();
  initDarkMode();
  
  // Add keyboard listeners for pagination
  document.addEventListener('keydown', function(e) {
    // Only handle when not in input field
    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'SELECT') {
      if (e.key === 'ArrowLeft') {
        const prevBtn = document.getElementById('prevPage');
        if (!prevBtn.disabled) changePage(-1);
      } else if (e.key === 'ArrowRight') {
        const nextBtn = document.getElementById('nextPage');
        if (!nextBtn.disabled) changePage(1);
      }
    }
  });
});

// Dark mode initialization
function initDarkMode() {
  const darkModeToggle = document.getElementById('darkModeToggle');
  
  // Check for saved theme or system preference
  if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.documentElement.classList.add('dark');
  } else {
    document.documentElement.classList.remove('dark');
  }
  
  // Toggle dark mode
  darkModeToggle.addEventListener('click', function() {
    if (document.documentElement.classList.contains('dark')) {
      document.documentElement.classList.remove('dark');
      localStorage.theme = 'light';
    } else {
      document.documentElement.classList.add('dark');
      localStorage.theme = 'dark';
    }
  });
}

// Reset search function
function resetSearch() {
  document.getElementById("q").value = '';
  document.getElementById("category").value = 'Semua';
  hideElement("noResults");
  hideElement("results");
  hideElement("searchStats");
  hideElement("pagination");
  showElement("welcome");
  document.getElementById("q").focus();
}

// Handle Enter key press
function handleEnter(event) {
  if (event.key === 'Enter') {
    doSearch();
  }
}

// Quick search function
function quickSearch(query) {
  document.getElementById("q").value = query;
  document.getElementById("category").value = 'Semua';
  currentPage = 1;
  doSearch();
}

// Check database status on load
async function checkDatabaseStatus() {
  try {
    const res = await fetch('/stats');
    const data = await res.json();
    
    if (data.error) {
      displayDatabaseError();
    } else if (data.total_documents === 0) {
      displayDatabaseEmpty();
    }
  } catch (error) {
    console.error('Database status check error:', error);
  }
}

// Display database error
function displayDatabaseError() {
  const welcome = document.getElementById("welcome");
  welcome.innerHTML = `
    <div class="text-center py-8">
      <div class="text-7xl mb-6 text-red-500 dark:text-red-400">
        <i class="fas fa-database"></i>
      </div>
      <h2 class="text-2xl font-bold text-red-600 dark:text-red-500 mb-4">Database belum diindeks</h2>
      <p class="text-slate-600 dark:text-slate-400 mb-6 max-w-md mx-auto">Silakan jalankan proses indexing terlebih dahulu</p>
      <button onclick="reindexDatabase()" 
        class="px-6 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 shadow-md hover:shadow-lg transition-all"
        aria-label="Reindex database">
        <i class="fas fa-sync-alt mr-2"></i>Reindex Database
      </button>
    </div>
  `;
}

// Display empty database message
function displayDatabaseEmpty() {
  const welcome = document.getElementById("welcome");
  welcome.innerHTML = `
    <div class="text-center py-8">
      <div class="text-7xl mb-6 text-amber-500 dark:text-amber-400">
        <i class="fas fa-exclamation-circle"></i>
      </div>
      <h2 class="text-2xl font-bold text-amber-600 dark:text-amber-500 mb-4">Database kosong</h2>
      <p class="text-slate-600 dark:text-slate-400 mb-6 max-w-md mx-auto">Belum ada dokumen yang diindeks</p>
      <button onclick="reindexDatabase()" 
        class="px-6 py-3 bg-amber-600 text-white rounded-xl hover:bg-amber-700 shadow-md hover:shadow-lg transition-all"
        aria-label="Reindex database">
        <i class="fas fa-sync-alt mr-2"></i>Reindex Database
      </button>
    </div>
  `;
}

// Load available categories
async function loadCategories() {
  try {
    const res = await fetch('/categories');
    const data = await res.json();
    
    if (!data.error && data.categories) {
      const categorySelect = document.getElementById("category");
      const currentValue = categorySelect.value;
      
      // Keep the "Semua" option
      categorySelect.innerHTML = '<option value="Semua">Semua Kategori</option>';
      
      // Add categories from the API
      data.categories.forEach(category => {
        if (category) {  // Ensure not empty
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          categorySelect.appendChild(option);
        }
      });
      
      // Try to restore selected value
      if (currentValue) {
        categorySelect.value = currentValue;
      }
    }
  } catch (error) {
    console.error('Error loading categories:', error);
  }
}

// Show/hide elements
function showElement(id) {
  document.getElementById(id).classList.remove('hidden');
}

function hideElement(id) {
  document.getElementById(id).classList.add('hidden');
}

function showLoading() {
  document.getElementById("loading").classList.add('show');
}

function hideLoading() {
  document.getElementById("loading").classList.remove('show');
}

// Reindex the database
async function reindexDatabase() {
  try {
    const confirmed = confirm("Yakin ingin mengindeks ulang database? Proses ini mungkin memakan waktu beberapa saat.");
    if (!confirmed) return;
    
    // Display loading state
    document.getElementById('reindexBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Reindexing...';
    document.getElementById('reindexBtn').disabled = true;
    
    const res = await fetch('/reindex');
    const data = await res.json();
    
    alert(`Proses reindexing dimulai dari folder: ${data.folder}`);
    
    // Reset UI after a delay to allow background processing
    setTimeout(() => {
      document.getElementById('reindexBtn').innerHTML = '<i class="fas fa-sync-alt mr-2"></i> Reindex Database';
      document.getElementById('reindexBtn').disabled = false;
      loadCategories(); // Refresh categories after reindexing
    }, 3000);
  } catch (error) {
    console.error('Reindex error:', error);
    alert('Terjadi kesalahan saat mengindeks ulang database.');
    document.getElementById('reindexBtn').innerHTML = '<i class="fas fa-sync-alt mr-2"></i> Reindex Database';
    document.getElementById('reindexBtn').disabled = false;
  }
}

// Analyze corpus
async function analyzeCorpus() {
  try {
    // Display loading state
    document.getElementById('analyzeBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Menganalisis...';
    document.getElementById('analyzeBtn').disabled = true;
    
    const res = await fetch('/analyze');
    if (!res.ok) {
      throw new Error(`HTTP error: ${res.status}`);
    }
    
    const data = await res.json();
    displayAnalysis(data);
    
    // Reset UI
    document.getElementById('analyzeBtn').innerHTML = '<i class="fas fa-chart-bar mr-2"></i> Analisis Korpus';
    document.getElementById('analyzeBtn').disabled = false;
  } catch (error) {
    console.error('Analysis error:', error);
    alert('Terjadi kesalahan saat menganalisis korpus.');
    document.getElementById('analyzeBtn').innerHTML = '<i class="fas fa-chart-bar mr-2"></i> Analisis Korpus';
    document.getElementById('analyzeBtn').disabled = false;
  }
}

// Display analysis results
function displayAnalysis(data) {
  const content = document.getElementById('analysisContent');
  
  if (data.error) {
    content.innerHTML = `
      <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg text-red-700 dark:text-red-400">
        <p><i class="fas fa-exclamation-circle mr-2"></i>${data.error}</p>
      </div>
    `;
  } else {
    // Format the analysis data
    let html = `
      <div class="grid md:grid-cols-2 gap-6">
        <div class="bg-sky-50 dark:bg-sky-900/20 p-5 rounded-lg">
          <h4 class="font-semibold mb-3 text-sky-800 dark:text-sky-300">Statistik Dokumen</h4>
          <p class="mb-2"><span class="font-medium">Total dokumen:</span> ${data.total_documents}</p>
          <div class="mt-4">
            <h5 class="font-medium mb-2 text-sky-700 dark:text-sky-400">Distribusi Kategori:</h5>
            <ul class="space-y-2">
    `;
    
    // Calculate the total for percentage
    const totalCount = data.categories.reduce((sum, cat) => sum + cat.count, 0);
    
    data.categories.forEach(cat => {
      const percentage = (cat.count / totalCount * 100).toFixed(1);
      const barWidth = `${percentage}%`;
      const category = cat.category || 'Tanpa kategori';
      
      // Different colors for different categories
      let colorClass = 'bg-sky-500';
      if (category.toLowerCase().includes('wisata')) {
        colorClass = 'bg-green-500';
      } else if (category.toLowerCase().includes('budaya')) {
        colorClass = 'bg-purple-500';
      } else if (category.toLowerCase().includes('sejarah')) {
        colorClass = 'bg-blue-500';
      }
      
      html += `
        <li>
          <div class="flex items-center justify-between mb-1">
            <span class="font-medium text-slate-700 dark:text-slate-300">${category}</span>
            <span class="text-xs font-medium text-slate-600 dark:text-slate-400">${cat.count} (${percentage}%)</span>
          </div>
          <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5">
            <div class="${colorClass} h-2.5 rounded-full" style="width: ${barWidth}"></div>
          </div>
        </li>`;
    });
    
    html += `
            </ul>
          </div>
        </div>
        
        <div class="bg-green-50 dark:bg-green-900/20 p-5 rounded-lg">
          <h4 class="font-semibold mb-3 text-green-800 dark:text-green-300">Kata Paling Sering Muncul</h4>
          <ul class="space-y-2">
    `;
    
    // Find the max count for scaling
    const maxCount = Math.max(...data.top_words.map(w => w.count));
    
    data.top_words.forEach(word => {
      const percentage = (word.count / maxCount * 100).toFixed(0);
      const barWidth = `${percentage}%`;
      
      html += `
        <li>
          <div class="flex items-center justify-between mb-1">
            <span class="font-mono text-slate-700 dark:text-slate-300">${word.word}</span>
            <span class="text-xs font-medium text-slate-600 dark:text-slate-400">${word.count} kali</span>
          </div>
          <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5">
            <div class="bg-green-500 h-2.5 rounded-full" style="width: ${barWidth}"></div>
          </div>
        </li>`;
    });
    
    html += `
          </ul>
        </div>
      </div>
    `;
    
    content.innerHTML = html;
  }
  
  // Show the modal
  showElement('analysisModal');
  
  // Set focus for accessibility - first focusable element in modal
  setTimeout(() => {
    document.querySelector('#analysisModal button').focus();
  }, 100);
  
  // Trap focus in modal
  const modal = document.getElementById('analysisModal');
  const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
  const firstElement = focusableElements[0];
  const lastElement = focusableElements[focusableElements.length - 1];
  
  modal.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeAnalysisModal();
    }
    
    if (e.key === 'Tab') {
      if (e.shiftKey) {
        if (document.activeElement === firstElement) {
          lastElement.focus();
          e.preventDefault();
        }
      } else {
        if (document.activeElement === lastElement) {
          firstElement.focus();
          e.preventDefault();
        }
      }
    }
  });
}

// Close analysis modal
function closeAnalysisModal() {
  hideElement('analysisModal');
  document.getElementById('analyzeBtn').focus(); // Return focus
}

// Pagination handler
function changePage(delta) {
  const newPage = currentPage + delta;
  if (newPage >= 1 && newPage <= totalPages) {
    currentPage = newPage;
    doSearch(false); // Don't reset the page number
  }
}

// Update pagination UI
function updatePaginationUI() {
  document.getElementById("currentPage").textContent = currentPage;
  document.getElementById("totalPages").textContent = totalPages;
  
  const prevBtn = document.getElementById("prevPage");
  const nextBtn = document.getElementById("nextPage");
  
  prevBtn.disabled = currentPage <= 1;
  nextBtn.disabled = currentPage >= totalPages;
  
  // Show pagination only if there's more than one page
  if (totalPages > 1) {
    showElement("pagination");
  } else {
    hideElement("pagination");
  }
}

// Main search function
async function doSearch(resetPage = true) {
  const q = document.getElementById("q").value.trim();
  const category = document.getElementById("category").value;
  
  if (!q) {
    alert("Silakan masukkan kata kunci pencarian");
    return;
  }

  // Update state
  currentQuery = q;
  currentCategory = category;
  if (resetPage) currentPage = 1;

  // Start loading
  searchStartTime = Date.now();
  showLoading();
  hideElement("welcome");
  hideElement("results");
  hideElement("noResults");
  hideElement("searchStats");
  hideElement("pagination");

  try {
    // Build search URL with parameters
    const params = new URLSearchParams({
      q: q,
      limit: RESULTS_PER_PAGE,
      page: currentPage
    });
    
    if (category !== 'Semua') {
      params.append('category', category);
    }
    
    const url = `/search?${params.toString()}`;
    const res = await fetch(url);
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    
    const data = await res.json();
    const searchTime = Date.now() - searchStartTime;
    
    // Update pagination state
    totalPages = data.pages || 1;
    
    hideLoading();
    displayResults(data, q, searchTime);
    updatePaginationUI();
    
  } catch (error) {
    hideLoading();
    console.error('Search error:', error);
    displayError("Terjadi kesalahan saat mencari. Silakan coba lagi.");
  }
}

// Display search results
function displayResults(data, query, searchTime) {
  const resultsBox = document.getElementById("results");
  resultsBox.innerHTML = "";

  if (!data.results || data.results.length === 0) {
    showElement("noResults");
    return;
  }

  // Show search stats
  document.getElementById("resultCount").textContent = data.total;
  document.getElementById("queryText").textContent = query;
  document.getElementById("searchTime").textContent = searchTime;
  showElement("searchStats");

  // Calculate starting result number for pagination
  const startIndex = (currentPage - 1) * RESULTS_PER_PAGE;

  // Display results
  data.results.forEach((result, index) => {
    const resultNumber = startIndex + index + 1;
    const item = document.createElement("div");
    item.className = "result-item bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200/70 dark:border-slate-700/50 hover:shadow-md";
    
    const snippet = result.snippet || "Tidak ada preview tersedia.";
    const cleanSnippet = snippet.replace(/<\/?mark>/g, (match) => 
      match === '<mark>' ? '<mark>' : '</mark>'
    );
    
    // Determine category badge color
    let categoryClass = "bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300";
    if (result.category) {
      const category = result.category.toLowerCase();
      if (category.includes('sejarah')) {
        categoryClass = "bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300";
      } else if (category.includes('wisata')) {
        categoryClass = "bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300";
      } else if (category.includes('budaya')) {
        categoryClass = "bg-purple-100 text-purple-700 dark:bg-purple-900/40 dark:text-purple-300";
      } else if (category.includes('tradisi')) {
        categoryClass = "bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300";
      }
    }
    
    item.innerHTML = `
      <div class="flex items-start gap-4">
        <div class="hidden sm:flex shrink-0">
          <div class="w-12 h-12 bg-gradient-to-br from-sky-400 to-indigo-500 dark:from-sky-500 dark:to-indigo-600 rounded-lg flex items-center justify-center shadow-sm">
            <span class="text-white font-semibold text-lg">${resultNumber}</span>
          </div>
        </div>
        <div class="flex-1">
          <div class="flex flex-wrap items-center gap-3 mb-3">
            <span class="inline-flex sm:hidden items-center justify-center w-6 h-6 bg-sky-100 dark:bg-sky-900/50 text-sky-600 dark:text-sky-400 rounded-full text-xs font-semibold">
              ${resultNumber}
            </span>
            <h3 class="font-bold text-xl text-slate-800 dark:text-slate-100 hover:text-sky-600 dark:hover:text-sky-400 transition-colors line-clamp-2">
              ${escapeHtml(result.title)}
            </h3>
            <span class="${categoryClass} px-2.5 py-1 rounded-full text-xs font-medium">
              ${result.category || "Lainnya"}
            </span>
          </div>
          <p class="text-slate-600 dark:text-slate-300 mb-4 leading-relaxed">${cleanSnippet}</p>
          <div class="flex items-center justify-between">
            <div>
              ${result.url ? `
                <a href="${escapeHtml(result.url)}" target="_blank" 
                  class="inline-flex items-center text-sky-600 dark:text-sky-400 hover:text-sky-800 dark:hover:text-sky-300 font-medium text-sm transition-colors"
                  aria-label="Baca dokumen ${escapeHtml(result.title)}">
                  <i class="fas fa-external-link-alt mr-2"></i>
                  Baca selengkapnya
                </a>
              ` : ''}
            </div>
            <span class="text-xs text-slate-500 dark:text-slate-400 font-mono">
              Skor: <span class="font-semibold">${parseFloat(result.score).toFixed(2)}</span>
            </span>
          </div>
        </div>
      </div>
    `;
    
    resultsBox.appendChild(item);
  });

  showElement("results");
}

// Display error message
function displayError(message) {
  const resultsBox = document.getElementById("results");
  resultsBox.innerHTML = `
    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/30 rounded-xl p-6 text-center">
      <div class="text-5xl mb-4 text-red-500 dark:text-red-400">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <h3 class="text-lg font-semibold text-red-800 dark:text-red-300 mb-2">Terjadi Kesalahan</h3>
      <p class="text-red-600 dark:text-red-400">${message}</p>
      <button onclick="location.reload()" 
              class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
              aria-label="Muat ulang halaman">
        <i class="fas fa-redo mr-2"></i>Muat Ulang Halaman
      </button>
    </div>
  `;
  showElement("results");
}

// Utility function to escape HTML
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
</body>
</html>